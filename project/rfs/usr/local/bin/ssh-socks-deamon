#!/bin/bash

socks_port=$2

ssh_info=$(echo "$1" | tr @ :)

ssh_user=$(echo "$ssh_info" | cut -d : -f 1)
ssh_host=$(echo "$ssh_info" | cut -d : -f 2)
ssh_port=$(echo "$ssh_info" | cut -d : -f 3)

if [ -z "$socks_port" -z "$ssh_user" -o -z "$ssh_host" ]
then
	echo "Usage:$(basename $0) <user@host:port> <socks-port>"
	exit 1
fi

[ -z "$ssh_port" ] && port=22

while true
do
	ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=5 -o TCPKeepAlive=yes -D $socks_port -C $ssh_user@$ssh_host -p $ssh_port ping 127.0.0.1 > /dev/null
	sleep 1
done
